# Build the PDF of the manuscript.
#
# Commands:
#
#	make          Compile PDF in the output folder
#	make wc       Count the number of words in the generated PDF
#	make clean    Delete all generated files


# CONFIGURATION
###############################################################################

# The name of the main .tex file to build.
# Other files can be included into this one.
PROJECT = manuscript

# For the autogenerated revision marked manuscript
R1 = $(PROJECT)-marked-R1
R1_GIT_TAG = submission

# Folder where the figure files are (will assume they are EPS format)
FIGS = ../figures

# File Types (for dependencies)
TEX = $(wildcard *.tex)
BIB = $(wildcard *.bib)
STY = $(wildcard *.sty)
CLS = $(wildcard *.cls)
BST = $(wildcard *.bst)
EPS = $(wildcard $(FIGS)/*.eps)

# Compilation Flags
LATEX_FLAGS = -halt-on-error -shell-escape


# TARGETS
###############################################################################

all: $(PROJECT).pdf

wc: $(PROJECT).pdf
	@ pdftotext $< - | wc -w

# This target cleans the temporary files generated by the tex programs in use.
clean::
	rm -rf *.aux *.log *.bbl *.blg *.out *.toc
	rm -rf $(PROJECT).pdf
	rm -rf $(FIGS)/*-eps-converted-to.pdf

%.aux: %.tex $(STY) $(CLS) $(BIB) $(BST) $(EPS) $(TEX)
	pdflatex $(LATEX_FLAGS) $<

%.bbl: %.aux $(BIB) $(BST)
	bibtex $(patsubst %.tex,%,$<)
	pdflatex $(LATEX_FLAGS) $(patsubst %.aux,%.tex,$<) 1>/dev/null

%.pdf: %.aux $(PROJECT).bbl
	pdflatex $(LATEX_FLAGS) $(patsubst %.aux,%.tex,$<) 1>/dev/null

# Make the version with marked revisions (compares against the git tag
# "submission")
r1: $(R1).pdf

$(R1).tex: $(PROJECT).tex $(STY) $(CLS) $(EPS)
	git ldiff $(R1_GIT_TAG) $< > $@
