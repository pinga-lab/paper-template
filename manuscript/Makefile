# Build the PDF of the manuscript.
#
# Commands:
#
#	make            Compile PDF in the output folder
#	make show       Show the generated PDF (only Linux and Mac)
#	make wc         Count the number of words in manuscript
#	make clean      Delete all generated files
#	make greyscale  Create greyscale version of the PDF


# CONFIGURATION
###############################################################################

# The name of the main .tex file to build.
# Other latex files should be included into this one.
PROJECT = manuscript
# Folder with the figure files
FIGDIR = figures
# Folder where output will be placed
OUTDIR = output
# Name of the output file
OUTPUT = $(OUTDIR)/$(PROJECT).pdf

### File Types (for dependencies)
TEX = $(wildcard *.tex)
BIB = $(wildcard *.bib)
STY = $(wildcard *.sty)
CLS = $(wildcard *.cls)
BST = $(wildcard *.bst)
EPS = $(wildcard $(FIGDIR)/*.eps)
PNG = $(wildcard $(FIGDIR)/*.png)
PDF = $(wildcard $(FIGDIR)/*.pdf)
JPG = $(wildcard $(FIGDIR)/*.jpg)
FIGS = $(EPS) $(PNG) $(PDF) $(JPG)

### Compilation Flags
LATEX_FLAGS  = -halt-on-error -output-directory $(OUTDIR)/

### Set commands for opening the generated PDF
UNAME := $(shell uname)
ifeq ($(UNAME), Linux)
PDFVIEWER = xdg-open
endif
ifeq ($(UNAME), Darwin)
PDFVIEWER = open
endif


# TARGETS
###############################################################################

# Main target. Executed when calling 'make' with no arguments
all: $(OUTPUT)

# Open the PDF
show: $(OUTPUT)
	@ # Redirect stdout and stderr to /dev/null for silent execution
	@ (${PDFVIEWER} $(OUTPUT) > /dev/null 2>&1 & )

# Count the number of words in the manuscript. Not perfect and will skip any
# included files.
wc:
	@ detex $(PROJECT).tex | wc -w

# Check the text for common mistakes
lint:
	@ proselint $(PROJECT).tex

# Create greyscale PDF version
greyscale: $(OUTPUT)/$(PROJECT).pdf
    gs \
   -sDEVICE=pdfwrite \
   -sProcessColorModel=DeviceGray \
   -sColorConversionStrategy=Gray \
   -dOverrideICC \
   -o $(OUTPUT)/$(PROJECT)-greyscale.pdf \
   -f $(OUTPUT)/$(PROJECT).pdf

### Clean
# This target cleans the temporary files generated by the tex programs in
# use. All temporary files generated by this makefile will be placed in OUTDIR
# so cleanup is easy.
clean::
	rm -rf $(OUTDIR)/ *.aux
	rm -rf $(FIGDIR)/*-eps-converted-to.pdf

# Compile the PDF output
$(OUTPUT): $(PROJECT).tex $(STY) $(CLS) $(BIB) $(BST) $(FIGS) $(TEX)
	# Create the output directory if it doesn't exist
	mkdir -p $(OUTDIR)/
	cp $(BIB) $(BST) $(OUTDIR)
	pdflatex $(LATEX_FLAGS) $<
	cd $(OUTDIR) && bibtex $(patsubst %.tex,%,$<)
	pdflatex $(LATEX_FLAGS) $< 1>/dev/null
	pdflatex $(LATEX_FLAGS) $<
